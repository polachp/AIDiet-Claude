<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kop√≠rovat testovac√≠ data - AI Diet</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            margin-top: 0;
        }
        .info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #2196F3;
        }
        .success {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #4CAF50;
        }
        .error {
            background: #ffebee;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
        button {
            background: #7B9F8E;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #6a8e7d;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
        }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-info { color: #2196F3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Kop√≠rovat testovac√≠ data</h1>

        <div class="info">
            <strong>Tento n√°stroj zkop√≠ruje dne≈°n√≠ j√≠dla na p≈ôedchoz√≠ dny.</strong><br>
            Pou≈æijte pro vytvo≈ôen√≠ testovac√≠ch dat pro grafy a statistiky.
        </div>

        <div id="authSection">
            <p><strong>Stav p≈ôihl√°≈°en√≠:</strong> <span id="authStatus">Nep≈ôihl√°≈°en</span></p>
            <button id="loginBtn" onclick="loginUser()">P≈ôihl√°sit se</button>
        </div>

        <div id="copySection" style="display: none;">
            <p><strong>P≈ôihl√°≈°en jako:</strong> <span id="userEmail"></span></p>
            <button onclick="logoutUser()">Odhl√°sit se</button>
            <hr>

            <h3>Zkop√≠rovat dne≈°n√≠ j√≠dla:</h3>
            <button onclick="copyToYesterday()">üìÖ Na vƒçerej≈°√≠ den</button>
            <button onclick="copyToDayBeforeYesterday()">üìÖ Na p≈ôedevƒç√≠rej≈°√≠ den</button>
            <button onclick="copyToMultipleDays()">üìÖ Na oba p≈ôedchoz√≠ dny</button>
        </div>

        <div id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        let currentUser = null;
        let app, auth, db;

        // Log function (must be defined first)
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString('cs-CZ');
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAin9KU4sDbyB_GxGC_yBf96CodHFgyna0",
            authDomain: "ai-diet-calories-count.firebaseapp.com",
            projectId: "ai-diet-calories-count",
            storageBucket: "ai-diet-calories-count.firebasestorage.app",
            messagingSenderId: "75977167085",
            appId: "1:75977167085:web:00db4ac5dd60318ed63ce4"
        };

        // Initialize Firebase
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('‚úÖ Firebase initialized');
            log('Firebase inicializov√°n', 'success');
        } catch (error) {
            console.error('‚ùå Firebase error:', error);
            log(`Chyba Firebase: ${error.message}`, 'error');
        }

        // Auth state observer
        firebase.auth().onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                document.getElementById('authStatus').textContent = 'P≈ôihl√°≈°en';
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('authSection').style.display = 'none';
                document.getElementById('copySection').style.display = 'block';
                log(`P≈ôihl√°≈°en jako ${user.email}`, 'success');
            } else {
                document.getElementById('authStatus').textContent = 'Nep≈ôihl√°≈°en';
                document.getElementById('authSection').style.display = 'block';
                document.getElementById('copySection').style.display = 'none';
            }
        });

        // Login
        async function loginUser() {
            try {
                log('Otev√≠r√°m p≈ôihla≈°ovac√≠ okno...', 'info');
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await firebase.auth().signInWithPopup(provider);
                log(`√öspƒõ≈°nƒõ p≈ôihl√°≈°en jako ${result.user.email}`, 'success');
            } catch (error) {
                console.error('Login error:', error);
                if (error.code === 'auth/popup-closed-by-user') {
                    log('P≈ôihl√°≈°en√≠ zru≈°eno u≈æivatelem', 'info');
                } else if (error.code === 'auth/popup-blocked') {
                    log('Popup blokov√°n prohl√≠≈æeƒçem! Povolte vyskakovac√≠ okna pro tuto str√°nku.', 'error');
                } else {
                    log(`Chyba p≈ôihl√°≈°en√≠: ${error.message}`, 'error');
                }
            }
        }

        // Logout
        async function logoutUser() {
            try {
                await firebase.auth().signOut();
                log('Odhl√°≈°en', 'info');
            } catch (error) {
                log(`Chyba odhl√°≈°en√≠: ${error.message}`, 'error');
            }
        }

        // Get date string
        function getDateString(daysOffset = 0) {
            const date = new Date();
            date.setDate(date.getDate() + daysOffset);
            return date.toISOString().split('T')[0];
        }

        // Copy meals to a specific date
        async function copyMealsToDate(targetDateString) {
            if (!currentUser) {
                log('Nejste p≈ôihl√°≈°en!', 'error');
                return;
            }

            try {
                const todayString = getDateString(0);
                const userId = currentUser.uid;

                log(`Naƒç√≠t√°m j√≠dla z ${todayString}...`, 'info');

                // Get today's meals
                const todayMealsRef = db.collection('users').doc(userId)
                    .collection('meals').doc(todayString).collection('items');
                const snapshot = await todayMealsRef.get();

                if (snapshot.empty) {
                    log('Dnes nem√°te ≈æ√°dn√° j√≠dla ke kop√≠rov√°n√≠!', 'error');
                    return;
                }

                log(`Nalezeno ${snapshot.size} j√≠del`, 'info');

                // Copy to target date
                const targetMealsRef = db.collection('users').doc(userId)
                    .collection('meals').doc(targetDateString).collection('items');

                let copiedCount = 0;
                for (const doc of snapshot.docs) {
                    const mealData = doc.data();

                    // Update the date field
                    const newMealData = {
                        ...mealData,
                        date: targetDateString,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    };

                    await targetMealsRef.add(newMealData);
                    copiedCount++;
                    log(`Zkop√≠rov√°no: ${mealData.name}`, 'success');
                }

                log(`‚úÖ √öspƒõ≈°nƒõ zkop√≠rov√°no ${copiedCount} j√≠del na ${targetDateString}`, 'success');

            } catch (error) {
                log(`‚ùå Chyba: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Copy to yesterday
        async function copyToYesterday() {
            const yesterday = getDateString(-1);
            log(`--- Kop√≠ruji na vƒçerej≈°√≠ den (${yesterday}) ---`, 'info');
            await copyMealsToDate(yesterday);
        }

        // Copy to day before yesterday
        async function copyToDayBeforeYesterday() {
            const dayBeforeYesterday = getDateString(-2);
            log(`--- Kop√≠ruji na p≈ôedevƒç√≠rej≈°√≠ den (${dayBeforeYesterday}) ---`, 'info');
            await copyMealsToDate(dayBeforeYesterday);
        }

        // Copy to multiple days
        async function copyToMultipleDays() {
            log(`=== Kop√≠ruji na v√≠ce dn√≠ ===`, 'info');
            await copyToYesterday();
            await copyToDayBeforeYesterday();
            log(`=== Hotovo! ===`, 'success');
        }

        log('üöÄ N√°stroj pro kop√≠rov√°n√≠ dat p≈ôipraven', 'info');
    </script>
</body>
</html>
